
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Логи приложения</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: #f4f7f6; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 1rem; }
        header { background-color: #fff; padding: 1.5rem; border-bottom: 1px solid #ddd; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .header-controls { display: flex; align-items: center; gap: 1.5rem; }
        header button { background-color: #6c757d; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 4px; cursor: pointer; }
        header button:hover { background-color: #5a6268; }
        h1 { color: #333; margin: 0; }
        .card { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1.5rem; }
        .back-link { font-size: 1em; color: #007bff; text-decoration: none; }
        .back-link:hover { text-decoration: underline; }
        .loader { text-align: center; padding: 2rem; }
        .error-message { color: #dc3545; font-weight: bold; text-align: center; padding: 1rem; }
        .log-controls { margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; }
        .log-controls button { background-color: #007bff; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 4px; cursor: pointer; font-size: 1em; }
        .log-controls button:hover { background-color: #0056b3; }
        #log-container { background-color: #2b2b2b; color: #f1f1f1; font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; word-wrap: break-word; padding: 1rem; border-radius: 4px; max-height: 70vh; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 id="page-title">Логи приложения</h1>
        <div class="header-controls">
            <a href="/" class="back-link">&larr; Вернуться к приложениям</a>
            <button id="logout-btn">Выход</button>
        </div>
    </header>
    <div class="card">
        <div class="log-controls">
            <button id="refresh-btn">Обновить</button>
            <span id="status-text"></span>
        </div>
        <div id="log-container">
            <div class="loader">Загрузка логов...</div>
        </div>
    </div>
</div>

<script>
    // --- НОВЫЙ БЛОК: Безопасность и хелперы ---
    (function() {
        const token = localStorage.getItem('deployer_token');
        if (!token) {
            window.location.href = '/login';
        }
    })();

    async function authedFetch(url, options = {}) {
        const token = localStorage.getItem('deployer_token');

        const headers = {
            ...options.headers,
            'Authorization': `Bearer ${token}`
        };

        const response = await fetch(url, { ...options, headers });

        if (response.status === 401) { // Не авторизован (токен истек или невалиден)
            localStorage.removeItem('deployer_token');
            alert('Ваша сессия истекла. Пожалуйста, войдите снова.');
            window.location.href = '/login';
            return new Promise(() => {});
        }
        return response;
    }
    // --- КОНЕЦ НОВОГО БЛОКА ---

document.addEventListener('DOMContentLoaded', () => {
    // --- ИЗМЕНЕНО: Правильная логика выхода ---
    document.getElementById('logout-btn').addEventListener('click', async () => {
        try {
            // Вызываем API, чтобы сервер удалил HttpOnly cookie
            await authedFetch('/api/logout', { method: 'POST' });
        }
        catch (error) {
            console.error('Logout failed:', error);
        }
        finally {
            // В любом случае чистим localStorage и перенаправляем на страницу входа
            localStorage.removeItem('deployer_token');
            window.location.href = '/login';
        }
    });

    const logContainer = document.getElementById('log-container');
    const pageTitle = document.getElementById('page-title');
    const refreshBtn = document.getElementById('refresh-btn');
    const statusText = document.getElementById('status-text');

    const params = new URLSearchParams(window.location.search);
    const appName = params.get('app');

    if (!appName) {
        logContainer.innerHTML = '<p class="error-message">Ошибка: Имя приложения не указано в URL.</p>';
        return;
    }

    pageTitle.textContent = `Логи для "${appName}"`;

    async function fetchLogs() {
        statusText.textContent = 'Загрузка...';
        refreshBtn.disabled = true;
        try {
            const response = await authedFetch(`/api/apps/${appName}/logs?lines=200`); // Запрашиваем последние 200 строк
            if (!response.ok) {
                let errorMsg = `HTTP Error: ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.detail || errorMsg;
                } catch (e) { /* ignore json parsing error */ }
                throw new Error(errorMsg);
            }

            const data = await response.json();
            renderLogs(data.logs);
            statusText.textContent = `Загружено. Время: ${new Date().toLocaleTimeString()}`;

        } catch (error) {
            console.error("Failed to fetch logs:", error);
            logContainer.innerHTML = `<p class="error-message">Не удалось загрузить логи: ${error.message}</p>`;
            statusText.textContent = 'Ошибка загрузки.';
        } finally {
            refreshBtn.disabled = false;
        }
    }

    function renderLogs(logs) {
        if (!logs || logs.length === 0) {
            logContainer.textContent = 'Лог-файл пуст или еще не создан.';
            return;
        }
        logContainer.textContent = logs.join('\n');
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    refreshBtn.addEventListener('click', fetchLogs);

    fetchLogs();
});
</script>

</body>
</html>